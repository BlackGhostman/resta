<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selección de Productos - Sistema</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .grid-cell { min-height: 80px; min-width: 80px; }
    </style>
</head>
<body class="text-gray-200">

    <div id="root"></div>

    <script type="text/babel">
        window.onload = function() {
            const { useState, useEffect, useCallback } = React;

            const SVG_ICONS = {
                Menu: '<line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" />',
                CircleUser: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>',
                UtensilsCrossed: '<path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8" /><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Zm0 0 7 7" /><path d="m2.1 2.1 6.4 6.4" />',
                X: '<path d="M18 6 6 18" /><path d="m6 6 12 12" />',
                Armchair: '<path d="M19 9V6a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v3" /><path d="M3 16a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2Z" /><path d="M5 11v-2" /><path d="M19 9v2" />',
                Beer: '<path d="M17 11h1a3 3 0 0 1 0 6h-1" /><path d="M9 12v6" /><path d="M13 12v6" /><path d="M14 7.5c0-.28.22-.5.5-.5h1c.28 0 .5.22.5.5c0 .28-.22.5-.5.5h-1c-.28 0-.5-.22-.5-.5Z" /><path d="M12 20a6 6 0 0 1-6-6V7H4v10a8 8 0 0 0 8 8Z" />',
                MapPin: '<path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" />',
                Pencil: '<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /><path d="m15 5 4 4" />',
                Users: '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" />'
            };

            const Icon = ({ name, className = '', ...props }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props} dangerouslySetInnerHTML={{ __html: SVG_ICONS[name] || '' }} />
            );

            const getInitials = (name) => {
                if (!name) return '';
                const words = name.trim().split(' ');
                if (words.length > 1) return words.map(word => word[0]).join('').toUpperCase().substring(0, 2);
                return name.substring(0, 2).toUpperCase();
            };

            function ArticleCard({ article, onSelect }) {
                const defaultImageUrl = 'https://placehold.co/200x150/2d3748/e2e8f0?text=Producto';
                const imageUrl = article.url_imagen || defaultImageUrl;

                return (
                    <div 
                        className="bg-gray-800 rounded-lg shadow-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform duration-200 flex flex-col min-w-32 m-2"
                        onClick={() => onSelect(article)}
                    >
                        <img src={imageUrl} alt={article.nombre} className="w-full h-32 object-cover" onError={(e) => { e.target.onerror = null; e.target.src=defaultImageUrl; }} />
                        <div className="p-3 flex flex-col flex-grow justify-between">
                            <h3 className="font-semibold text-white text-base leading-tight h-12 flex items-center justify-center">{article.nombre}</h3>
                            <p className="text-cyan-400 font-bold text-lg mt-2">{new Intl.NumberFormat('es-CR', { style: 'currency', currency: 'CRC' }).format(article.precio)}</p>
                        </div>
                    </div>
                );
            }


            const Sidebar = ({ families, activeFamilyId, onFamilyClick, isSidebarOpen, setIsSidebarOpen }) => {
                const handleFamilyClick = (familyId) => {
                    onFamilyClick(familyId);
                };

                return (
                    <div className={`fixed top-0 left-0 z-40 h-screen bg-gray-900 transition-all duration-300 ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
                        <div className="flex flex-col h-full p-4">
                            <div>
                                <div className={`flex items-center mb-6 h-[2.125rem] ${isSidebarOpen ? 'justify-between' : 'justify-center'}`}>
                                        <a href="#" className={`flex items-center ps-2.5 ${!isSidebarOpen && 'hidden'}`}>
                                            <Icon name="UtensilsCrossed" className="h-6 w-6 me-3 text-cyan-400" />
                                            <span className="self-center text-2xl font-semibold whitespace-nowrap text-white">FAMILIAS</span>
                                        </a>
                                        <button onClick={() => setIsSidebarOpen(true)} className={`p-2 rounded-md hover:bg-gray-700 ${!isSidebarOpen ? 'inline' : 'hidden'}`}>
                                            <Icon name="Menu" className="w-6 h-6" />
                                        </button>
                                        <button onClick={() => setIsSidebarOpen(false)} className={`p-2 rounded-md hover:bg-gray-700 lg:hidden ${isSidebarOpen ? 'inline' : 'hidden'}`}><Icon name="X" className="w-6 h-6" /></button>
                                    </div>
                                <ul className="space-y-3 font-medium">
                                    {families.map(family => (
                                        <li key={`${family.id}-${family.nombre}`}>
                                            <button onClick={() => handleFamilyClick(family.id)} className={`w-full flex items-center p-3 text-gray-200 rounded-lg group transition-colors ${activeFamilyId === family.id ? 'bg-white/10' : 'hover:bg-white/5'} ${!isSidebarOpen && 'justify-center'}`}>
                                                <Icon name='UtensilsCrossed' className={`flex-shrink-0 w-8 h-8 transition duration-75 ${activeFamilyId === family.id ? 'text-cyan-400' : 'text-gray-400 group-hover:text-white'}`} />
                                                <span className={`flex-1 ms-3 whitespace-nowrap ${isSidebarOpen ? 'inline' : 'hidden'}`}>{family.nombre}</span>
                                                <span className={`text-sm font-semibold whitespace-nowrap ${!isSidebarOpen ? 'inline' : 'hidden'}`}>{getInitials(family.nombre)}</span>
                                            </button>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                            <div className="mt-auto pt-8 space-y-3">
                                <a href="/resta2/mesas.html" className={`w-full flex items-center p-3 rounded-lg transition-colors bg-gray-700 hover:bg-gray-600 text-gray-200 ${isSidebarOpen ? 'justify-start' : 'justify-center'}`}>
                                    <Icon name="Armchair" className="flex-shrink-0" /> <span className={`ms-3 whitespace-nowrap ${isSidebarOpen ? 'inline' : 'hidden'}`}>Mesas</span>
                                </a>
                                <a href="/resta2/editor.html" className={`w-full flex items-center p-3 rounded-lg transition-colors bg-gray-700 hover:bg-gray-600 text-gray-200 ${isSidebarOpen ? 'justify-start' : 'justify-center'}`}>
                                    <Icon name="Pencil" className="flex-shrink-0" /> <span className={`ms-3 whitespace-nowrap ${isSidebarOpen ? 'inline' : 'hidden'}`}>Modo Editor</span>
                                </a>
                            </div>
                        </div>
                    </div>
                );
            }

            function Header({ activeFamilyName, isSidebarOpen, setIsSidebarOpen, onToggleOrderPanel }) {
                return (
                    <header className="flex items-center justify-between p-4 bg-gray-800/80 backdrop-blur-sm border-b border-gray-700/50 lg:hidden">
                        <button onClick={() => setIsSidebarOpen(prev => !prev)} className="p-2 rounded-md hover:bg-gray-700 lg:hidden"><Icon name="Menu" className="w-6 h-6" /></button>
                        <h1 className="text-xl font-bold text-white">{activeFamilyName}</h1>
                        <button onClick={onToggleOrderPanel} className="p-2 rounded-full hover:bg-gray-700"><Icon name="CircleUser" className="w-6 h-6" /></button>
                    </header>
                );
            }

            const OrderPanel = ({ pedido, onSendOrder, isOpen }) => {
                const calcularTotal = () => {
                    return pedido.reduce((total, item) => total + item.precio * item.cantidad, 0);
                };

                return (
                    <div className={`fixed top-0 right-0 z-30 h-screen bg-gray-900 transition-transform duration-300 ${isOpen ? 'translate-x-0' : 'translate-x-full'} w-80 md:w-96 p-6 flex flex-col shadow-lg border-l border-gray-700/50`}>
                        <h2 className="text-3xl font-bold text-white mb-6 border-b-2 border-gray-700 pb-4">Pedido Actual</h2>
                        <div className="flex-grow overflow-y-auto pr-2">
                            {pedido.length === 0 ? (
                                <p className="text-gray-400 text-center mt-8">No hay productos en el pedido.</p>
                            ) : (
                                <ul className="space-y-4">
                                    {pedido.map(item => (
                                        <li key={item.id_articulos} className="flex justify-between items-center bg-gray-800 p-3 rounded-lg">
                                            <div>
                                                <p className="font-semibold text-white">{item.nombre}</p>
                                                <p className="text-sm text-gray-400">
                                                    {new Intl.NumberFormat('es-CR', { style: 'currency', currency: 'CRC' }).format(item.precio)}
                                                </p>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className="font-bold text-white text-lg">{item.cantidad}</span>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                        <div className="mt-auto pt-6 border-t-2 border-gray-700">
                            <div className="flex justify-between items-center text-2xl font-bold text-white mb-4">
                                <span>Total:</span>
                                <span>{new Intl.NumberFormat('es-CR', { style: 'currency', currency: 'CRC' }).format(calcularTotal())}</span>
                            </div>
                            <button onClick={onSendOrder} className="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg text-lg transition-colors">
                                Enviar Pedido
                            </button>
                        </div>
                    </div>
                );
            };

            function ProductSelector() {
                const [families, setFamilies] = useState([]);
                const [articles, setArticles] = useState([]);
                const [activeFamilyId, setActiveFamilyId] = useState(null);
                const [loading, setLoading] = useState(true);
                const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 1024);
                const [isOrderPanelOpen, setIsOrderPanelOpen] = useState(false);
                const [idMesa, setIdMesa] = useState(null);
                const [pedido, setPedido] = useState([]);

                const FAMILIES_API_URL = 'api/familias.php';
                const ARTICLES_API_URL = 'api/articulos.php';

                useEffect(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const mesaId = urlParams.get('id_mesa');
                    if (mesaId) {
                        setIdMesa(mesaId);
                    }
                }, []);

                useEffect(() => {
                    setLoading(true);
                    fetch(FAMILIES_API_URL)
                        .then(res => res.json())
                        .then(data => {
                            if (Array.isArray(data)) {
                                setFamilies(data);
                                if (data.length > 0 && !activeFamilyId) {
                                    setActiveFamilyId(data[0].id);
                                }
                            } else {
                                setFamilies([]); // Asegurarse que sea un array en caso de error
                            }
                            setLoading(false);
                        })
                        .catch(err => {
                            console.error("Error fetching families:", err);
                            setLoading(false);
                        });
                }, []);

                useEffect(() => {
                    if (isOrderPanelOpen && window.innerWidth >= 1024) {
                        setIsSidebarOpen(false);
                    }
                }, [isOrderPanelOpen]);

                useEffect(() => {
                    if (isSidebarOpen && window.innerWidth >= 1024) {
                        setIsOrderPanelOpen(false);
                    }
                }, [isSidebarOpen]);

                useEffect(() => {
                    if (activeFamilyId) {
                        setLoading(true);
                        fetch(`${ARTICLES_API_URL}?familia_id=${activeFamilyId}`)
                            .then(res => res.json())
                            .then(data => {
                                setArticles(data || []);
                                setLoading(false);
                            })
                            .catch(err => {
                                console.error("Error fetching articles:", err);
                                setArticles([]);
                                setLoading(false);
                            });
                    }
                }, [activeFamilyId]);

                const handleArticleClick = (article) => {
                    if (!idMesa) {
                        alert("No se ha seleccionado una mesa. Por favor, vuelva a la pantalla de mesas.");
                        return;
                    }

                    const existingArticle = pedido.find(item => item.id_articulos === article.id_articulos);
                    let updatedOrder;

                    if (existingArticle) {
                        updatedOrder = pedido.map(item =>
                            item.id_articulos === article.id_articulos
                                ? { ...item, cantidad: item.cantidad + 1 }
                                : item
                        );
                    } else {
                        updatedOrder = [...pedido, { ...article, cantidad: 1 }];
                    }
                    setPedido(updatedOrder);
                };

                const handleSendOrder = async () => {
                    if (pedido.length === 0) {
                        alert("No hay artículos en el pedido.");
                        return;
                    }

                    try {
                        const response = await fetch('api/guardar_pedido.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                id_mesa: idMesa,
                                articulos: pedido,
                            }),
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.error || 'Error en el servidor');
                        }

                        if (result.success) {
                            alert("Pedido enviado con éxito.");
                            setPedido([]);
                        } else {
                            throw new Error(result.error || 'Error al guardar el pedido');
                        }
                    } catch (error) {
                        console.error('Error al enviar el pedido:', error);
                        alert(`Error al enviar el pedido: ${error.message}`);
                    }
                };

                if (loading && families.length === 0) {
                    return <div className="flex items-center justify-center h-screen bg-gray-900 text-white text-xl">Cargando familias de productos...</div>;
                }

                const activeFamily = families.find(f => f.id === activeFamilyId);

                return (
                    <div className="relative min-h-screen bg-gray-900">
                        <div className="relative flex h-screen">
                            <Sidebar 
                                families={families} 
                                activeFamilyId={activeFamilyId} 
                                onFamilyClick={setActiveFamilyId} 
                                isSidebarOpen={isSidebarOpen} 
                                setIsSidebarOpen={setIsSidebarOpen}
                            />
                            <div className={`flex-1 flex overflow-hidden transition-all duration-300 ${isSidebarOpen ? 'ml-64' : 'ml-20'} ${isOrderPanelOpen ? 'mr-80 md:mr-96' : ''}`}>
                                <div className="flex-1 flex flex-col overflow-hidden">
                                    <Header 
                                        activeFamilyName={activeFamily?.nombre || 'Sin Familias'} 
                                        isSidebarOpen={isSidebarOpen} 
                                        setIsSidebarOpen={() => setIsSidebarOpen(prev => !prev)}
                                        onToggleOrderPanel={() => setIsOrderPanelOpen(prev => !prev)}
                                    />
                                    <main className="flex-1 overflow-auto p-4 sm:p-6 md:p-8">
                                        <div className="hidden lg:flex items-center justify-between mb-8">
                                            <h1 className="text-4xl font-bold text-white">Seleccionar Producto: {activeFamily?.nombre || ''}</h1>
                                            <button onClick={() => setIsOrderPanelOpen(prev => !prev)} className="p-2 rounded-full hover:bg-gray-700">
                                                <Icon name="CircleUser" className="w-8 h-8" />
                                            </button>
                                        </div>
                                        <div className="bg-gray-800/50 p-4 rounded-lg">
                                            {!activeFamily ? (
                                                <div className="text-center text-gray-400 py-8">Selecciona una familia para ver los productos.</div>
                                            ) : (
                                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-8">
                                                    {articles.map(article => (
                                                        <ArticleCard key={article.id_articulos} article={article} onSelect={handleArticleClick} />
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </main>
                                </div>
                                <OrderPanel pedido={pedido} onSendOrder={handleSendOrder} isOpen={isOrderPanelOpen} />
                            </div>
                        </div>
                    </div>
                );
            }

            ReactDOM.render(<ProductSelector />, document.getElementById('root'));
        };
    </script>

</body>
</html>
