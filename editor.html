<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Ubicaciones - Sistema</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Dependencies: React, ReactDOM, Babel, and Lucide Icons -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- FIX: Pinned lucide-react to a different, more stable version -->
    <script src="https://unpkg.com/lucide-react@0.390.0/dist/umd/lucide-react.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .grid-cell {
            min-height: 80px;
            min-width: 80px;
        }
        .grid-cell.drag-over {
            background-color: #2563eb30; /* Blue-600 with opacity */
            border-color: #2563eb;
        }
        .adding-mode {
            cursor: copy;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="root"></div>

    <script type="text/babel">
        window.onload = function() {
            const { useState, useEffect, createElement, useRef } = React;

            // Helper to render Lucide icons
            const Icon = ({ name, ...props }) => {
                if (typeof lucide === 'undefined' || !lucide[name]) {
                    return <span style={{ display: 'inline-block', width: '1em', height: '1em' }}></span>;
                }
                return createElement(lucide[name], props);
            };

            // --- Initial Data for the Editor ---
            const initialTableData = {
                'Salón': [
                    { id: 1, number: '#1', row: 2, col: 3 }, { id: 2, number: '#2', row: 3, col: 3 },
                    { id: 3, number: '#3', row: 4, col: 3 }, { id: 4, number: '#4', row: 5, col: 3 },
                ],
                'Barra': [
                    { id: 101, number: 'B1', row: 2, col: 3 }, { id: 102, number: 'B2', row: 2, col: 5 },
                ],
            };

            function AddZoneModal({ show, onClose, value, onChange, onSave }) {
                const inputRef = useRef(null);

                useEffect(() => {
                    if (show) {
                        // Focus the input when the modal is shown.
                        setTimeout(() => inputRef.current?.focus(), 50);
                    }
                }, [show]);

                if (!show) return null;
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                        <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
                            <h3 className="text-lg font-medium text-white mb-4">Crear Nueva Zona</h3>
                            <input
                                ref={inputRef}
                                type="text"
                                value={value}
                                onChange={onChange}
                                placeholder="Nombre de la zona (ej: Terraza)"
                                className="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-3 mb-4"
                            />
                            <div className="flex justify-end gap-3">
                                <button onClick={onClose} className="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
                                <button onClick={onSave} className="px-4 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white">Guardar</button>
                            </div>
                        </div>
                    </div>
                );
            }

            const Sidebar = ({ isSidebarOpen, setIsSidebarOpen, tables, activeLocation, setActiveLocation, setSelectedTable, setIsAddingMode, isAddingMode, handleDeleteSelectedTable, selectedTable, setShowAddZoneModal, setShowDeleteZoneModal }) => (
                <aside className={`fixed top-0 left-0 z-40 w-64 h-screen bg-gray-900/80 backdrop-blur-md border-r border-gray-700 transition-transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>
                    <div className="h-full px-3 py-4 overflow-y-auto flex flex-col">
                        <div>
                            <div className="flex items-center justify-between mb-8">
                                <a href="#" className="flex items-center ps-2.5">
                                    <Icon name="UtensilsCrossed" className="h-6 w-6 me-3 text-cyan-400" />
                                    <span className="self-center text-2xl font-semibold whitespace-nowrap text-white">ZONAS</span>
                                </a>
                                <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden p-2 rounded-md hover:bg-gray-700">
                                    <Icon name="X" className="w-6 h-6" />
                                </button>
                            </div>
                            <ul className="space-y-3 font-medium">
                                {Object.keys(tables).map(location => (
                                    <li key={location}>
                                        <button onClick={() => { setActiveLocation(location); setIsSidebarOpen(false); setSelectedTable(null); setIsAddingMode(false); }} className={`w-full flex items-center p-3 text-gray-200 rounded-lg group transition-colors ${activeLocation === location ? 'bg-white/10' : 'hover:bg-white/5'}`}>
                                            <Icon name={location === 'Salón' ? 'Armchair' : location.includes('Barra') ? 'Beer' : 'MapPin'} className={`w-8 h-8 transition duration-75 ${activeLocation === location ? 'text-cyan-400' : 'text-gray-400 group-hover:text-white'}`} />
                                            <span className="ms-4 text-lg">{location}</span>
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                        <div className="mt-auto pt-8">
                            <h3 className="text-lg font-semibold text-white mb-4 px-2">Herramientas</h3>
                            <div className="space-y-3">
                                <button onClick={() => setIsAddingMode(true)} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${isAddingMode ? 'bg-cyan-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-200'}`}>
                                    <Icon name="PlusCircle" className="w-6 h-6" />
                                    <span>Añadir Mesa</span>
                                </button>
                                <button onClick={handleDeleteSelectedTable} disabled={!selectedTable} className="w-full flex items-center gap-3 p-3 rounded-lg transition-colors bg-red-800 hover:bg-red-700 text-gray-200 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <Icon name="Trash2" className="w-6 h-6" />
                                    <span>Eliminar Mesa</span>
                                </button>
                                <div className="border-t border-gray-700 my-4"></div>
                                <button onClick={() => setShowAddZoneModal(true)} className="w-full flex items-center gap-3 p-3 rounded-lg transition-colors bg-blue-700 hover:bg-blue-600 text-gray-200">
                                    <Icon name="LayoutGrid" className="w-6 h-6" />
                                    <span>Nueva Zona</span>
                                </button>
                                 <button onClick={() => setShowDeleteZoneModal(true)} className="w-full flex items-center gap-3 p-3 rounded-lg transition-colors bg-red-900 hover:bg-red-800 text-gray-200">
                                    <Icon name="LayoutGrid" className="w-6 h-6" />
                                    <span>Eliminar Zona Actual</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </aside>
            );

            const Header = ({ setIsSidebarOpen, activeLocation }) => (
                <header className="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-30 flex items-center justify-between lg:hidden px-4 py-3 border-b border-gray-700">
                    <button onClick={() => setIsSidebarOpen(true)} className="p-2 rounded-md hover:bg-gray-700">
                        <Icon name="Menu" className="w-6 h-6" />
                    </button>
                    <h1 className="text-xl font-bold text-white">Editor: {activeLocation}</h1>
                    <div className="p-2">
                        <Icon name="CircleUser" className="w-6 h-6" />
                    </div>
                </header>
            );

            function DeleteZoneModal({ show, onClose, onConfirm, zoneName }) {
                if (!show) return null;
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                        <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 text-center">
                            <Icon name="TriangleAlert" className="mx-auto mb-4 h-14 w-14 text-red-500" />
                            <h3 className="mb-5 text-lg font-normal text-gray-300">
                                ¿Seguro que quieres eliminar la zona "{zoneName}"? Esta acción no se puede deshacer.
                            </h3>
                            <div className="flex justify-center gap-4">
                                <button onClick={onClose} className="px-5 py-2.5 rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
                                <button onClick={onConfirm} className="px-5 py-2.5 rounded-lg bg-red-600 hover:bg-red-700 text-white">Sí, eliminar</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- Main App Component ---
            function LayoutEditor() {
                const [activeLocation, setActiveLocation] = useState('Salón');
                const [isSidebarOpen, setIsSidebarOpen] = useState(false);
                const [tables, setTables] = useState(initialTableData);
                const [isAddingMode, setIsAddingMode] = useState(false);
                const [selectedTable, setSelectedTable] = useState(null);
                
                // Modal States
                const [showAddZoneModal, setShowAddZoneModal] = useState(false);
                const [newZoneName, setNewZoneName] = useState('');
                const [showDeleteZoneModal, setShowDeleteZoneModal] = useState(false);

                const GRID_ROWS = 10;
                const GRID_COLS = 16;
                
                // --- Drag and Drop Handlers ---
                const handleDragStart = (e, tableId) => {
                    e.dataTransfer.setData("tableId", tableId);
                    setSelectedTable(tableId);
                };

                const handleDragOver = (e) => {
                    e.preventDefault();
                    e.currentTarget.classList.add('drag-over');
                };
                
                const handleDragLeave = (e) => {
                    e.currentTarget.classList.remove('drag-over');
                };

                const handleDrop = (e, toRow, toCol) => {
                    e.preventDefault();
                    e.currentTarget.classList.remove('drag-over');
                    
                    const isOccupied = tables[activeLocation].some(table => table.row === toRow && table.col === toCol);
                    if (isOccupied) return;

                    const tableId = e.dataTransfer.getData("tableId");
                    
                    setTables(prev => ({
                        ...prev,
                        [activeLocation]: prev[activeLocation].map(table => 
                            table.id == tableId ? { ...table, row: toRow, col: toCol } : table
                        )
                    }));
                };

                // --- Add/Remove Table Handlers ---
                const handleCellClick = (row, col) => {
                    if (!isAddingMode) return;
                    
                    const isOccupied = tables[activeLocation].some(table => table.row === row && table.col === col);
                    if (isOccupied) return;
                    
                    const newTableName = prompt(`Introduce el nombre para la nueva mesa en la celda (${row}, ${col}):`);
                    if (newTableName && newTableName.trim() !== "") {
                        const newTable = {
                            id: Date.now(),
                            number: newTableName.trim(),
                            row,
                            col
                        };
                        setTables(prev => ({
                            ...prev,
                            [activeLocation]: [...prev[activeLocation], newTable]
                        }));
                    }
                    setIsAddingMode(false);
                };

                const handleDeleteSelectedTable = () => {
                    if (!selectedTable) {
                        alert("Por favor, selecciona una mesa para eliminar.");
                        return;
                    }
                    if (confirm("¿Estás seguro de que deseas eliminar la mesa seleccionada?")) {
                         setTables(prev => ({
                            ...prev,
                            [activeLocation]: prev[activeLocation].filter(table => table.id !== selectedTable)
                        }));
                        setSelectedTable(null);
                    }
                };

                // --- Zone Handlers ---
                const handleAddZone = () => {
                    const name = newZoneName.trim();
                    if (name && !tables[name]) {
                        setTables(prev => ({
                            ...prev,
                            [name]: []
                        }));
                        setActiveLocation(name);
                        setShowAddZoneModal(false);
                        setNewZoneName('');
                    } else if (tables[name]) {
                        alert("Ya existe una zona con ese nombre.");
                    }
                };

                const handleDeleteZone = () => {
                    if (Object.keys(tables).length <= 1) {
                        alert("No puedes eliminar la última zona.");
                        setShowDeleteZoneModal(false);
                        return;
                    }
                    const { [activeLocation]: _, ...remainingTables } = tables;
                    setTables(remainingTables);
                    setActiveLocation(Object.keys(remainingTables)[0]);
                    setShowDeleteZoneModal(false);
                };
                
                // The Modal components are now defined outside LayoutEditor.

                // Sidebar is now defined outside the component

                // Header is now defined outside the component

                return (
                    <div className="relative min-h-screen bg-gray-800">
                        <AddZoneModal 
                            show={showAddZoneModal}
                            onClose={() => setShowAddZoneModal(false)}
                            value={newZoneName}
                            onChange={(e) => setNewZoneName(e.target.value)}
                            onSave={handleAddZone}
                        />
                        <DeleteZoneModal 
                            show={showDeleteZoneModal}
                            onClose={() => setShowDeleteZoneModal(false)}
                            onConfirm={handleDeleteZone}
                            zoneName={activeLocation}
                        />
                        <div className="relative flex h-screen">
                            <Sidebar {...{ isSidebarOpen, setIsSidebarOpen, tables, activeLocation, setActiveLocation, setSelectedTable, setIsAddingMode, isAddingMode, handleDeleteSelectedTable, selectedTable, setShowAddZoneModal, setShowDeleteZoneModal }} />
                            <div className="flex-1 flex flex-col overflow-hidden lg:ml-64">
                                <Header {...{ setIsSidebarOpen, activeLocation }} />
                                <main className={`flex-1 overflow-auto p-4 sm:p-6 md:p-8 ${isAddingMode ? 'adding-mode' : ''}`}>
                                    <h1 className="hidden lg:block text-4xl font-bold text-white mb-8">Editor de Plano: {activeLocation}</h1>
                                    <div className="bg-gray-900 p-4 rounded-lg">
                                        <div className="grid" style={{ gridTemplateColumns: `repeat(${GRID_COLS}, 1fr)`}}>
                                            {Array.from({ length: GRID_ROWS * GRID_COLS }).map((_, index) => {
                                                const row = Math.floor(index / GRID_COLS) + 1;
                                                const col = (index % GRID_COLS) + 1;
                                                const table = tables[activeLocation]?.find(t => t.row === row && t.col === col);
                                                
                                                return (
                                                    <div
                                                        key={`${row}-${col}`}
                                                        className="grid-cell border border-gray-700/50 flex items-center justify-center"
                                                        onDragOver={handleDragOver}
                                                        onDragLeave={handleDragLeave}
                                                        onDrop={(e) => handleDrop(e, row, col)}
                                                        onClick={() => handleCellClick(row, col)}
                                                    >
                                                        {table && (
                                                            <div
                                                                draggable
                                                                onDragStart={(e) => handleDragStart(e, table.id)}
                                                                onClick={() => { setSelectedTable(table.id); setIsAddingMode(false); }}
                                                                className={`p-2 h-16 w-16 flex items-center justify-center rounded-xl shadow-lg cursor-move transition-all ${selectedTable === table.id ? 'ring-2 ring-cyan-400' : ''} bg-gray-200 text-gray-900`}
                                                            >
                                                                <span className="text-xl font-bold">{table.number}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </main>
                            </div>
                        </div>
                    </div>
                );
            }

            ReactDOM.render(<LayoutEditor />, document.getElementById('root'));
        }
    </script>

</body>
</html>
